#!/bin/bash

# ðŸ§ª Test Environment Setup Script
# This script helps you set up a test environment for the Fraud Detection System

set -e

echo "ðŸ§ª Setting up Test Environment for Fraud Detection System"
echo "========================================================="

# Check if we're in the project root
if [ ! -f "backend/package.json" ]; then
    echo "âŒ Please run this script from the project root directory"
    exit 1
fi

# Create test environment file
echo "ðŸ“ Creating test environment configuration..."

cat > backend/.env.test << EOF
# Test Environment Configuration
# Generated by setup-test-env.sh

# Test Database URL
# For local testing with Docker:
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/test_db"

# For cloud test database (e.g., Neon, Supabase):
# DATABASE_URL="postgresql://username:password@host:port/test_database"

# Test Environment
NODE_ENV=test

# Test-specific configurations
LOG_LEVEL=debug
ENABLE_LOGGING=true

# Test API configurations
API_PORT=3001
API_HOST=localhost

# Test WebSocket configurations
WS_PORT=3002
WS_HOST=localhost
EOF

echo "âœ… Test environment file created: backend/.env.test"

# Create Docker Compose for test database
echo "ðŸ³ Creating Docker Compose for test database..."

cat > docker-compose.test.yml << EOF
version: '3.8'

services:
  test-db:
    image: postgres:15
    container_name: fraud-detection-test-db
    environment:
      POSTGRES_DB: test_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"  # Different port to avoid conflicts
    volumes:
      - test-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  test-db-data:
EOF

echo "âœ… Docker Compose file created: docker-compose.test.yml"

# Create test database setup script
echo "ðŸ”§ Creating test database setup script..."

cat > scripts/setup-test-db.sh << 'EOF'
#!/bin/bash

# Test Database Setup Script
# This script sets up a test database for the Fraud Detection System

set -e

echo "ðŸ—„ï¸ Setting up Test Database..."

# Start test database
echo "ðŸš€ Starting test database..."
docker-compose -f docker-compose.test.yml up -d

# Wait for database to be ready
echo "â³ Waiting for database to be ready..."
until docker-compose -f docker-compose.test.yml exec -T test-db pg_isready -U postgres; do
  echo "Database not ready yet, waiting..."
  sleep 2
done

echo "âœ… Database is ready!"

# Run database migrations
echo "ðŸ”„ Running database migrations..."
cd backend
npx prisma generate
npx prisma db push --schema=./prisma/schema.prisma

# Seed test data
echo "ðŸŒ± Seeding test data..."
npm run seed

echo "âœ… Test database setup complete!"
echo ""
echo "ðŸ“Š Test Database Info:"
echo "   Host: localhost"
echo "   Port: 5433"
echo "   Database: test_db"
echo "   Username: postgres"
echo "   Password: postgres"
echo ""
echo "ðŸ”— Connection URL: postgresql://postgres:postgres@localhost:5433/test_db"
EOF

chmod +x scripts/setup-test-db.sh

echo "âœ… Test database setup script created: scripts/setup-test-db.sh"

# Create test cleanup script
echo "ðŸ§¹ Creating test cleanup script..."

cat > scripts/cleanup-test-db.sh << 'EOF'
#!/bin/bash

# Test Database Cleanup Script
# This script cleans up the test database

set -e

echo "ðŸ§¹ Cleaning up Test Database..."

# Stop and remove test database
echo "ðŸ›‘ Stopping test database..."
docker-compose -f docker-compose.test.yml down -v

# Remove test environment file
echo "ðŸ—‘ï¸ Removing test environment file..."
rm -f backend/.env.test

echo "âœ… Test environment cleanup complete!"
EOF

chmod +x scripts/cleanup-test-db.sh

echo "âœ… Test cleanup script created: scripts/cleanup-test-db.sh"

# Update package.json scripts
echo "ðŸ“¦ Adding test scripts to package.json..."

# Check if scripts section exists in root package.json
if [ -f "package.json" ]; then
    echo "ðŸ“ Adding test scripts to root package.json..."
    # This would require more complex JSON manipulation
    echo "   Note: You may want to manually add these scripts to package.json:"
    echo "   \"test:setup\": \"./scripts/setup-test-db.sh\""
    echo "   \"test:cleanup\": \"./scripts/cleanup-test-db.sh\""
    echo "   \"test:db:start\": \"docker-compose -f docker-compose.test.yml up -d\""
    echo "   \"test:db:stop\": \"docker-compose -f docker-compose.test.yml down\""
fi

echo ""
echo "ðŸŽ‰ Test Environment Setup Complete!"
echo "=================================="
echo ""
echo "ðŸ“‹ Available Commands:"
echo "   ./scripts/setup-test-db.sh    - Set up test database"
echo "   ./scripts/cleanup-test-db.sh  - Clean up test database"
echo "   docker-compose -f docker-compose.test.yml up -d    - Start test database"
echo "   docker-compose -f docker-compose.test.yml down     - Stop test database"
echo ""
echo "ðŸ”§ Next Steps:"
echo "1. Review and update backend/.env.test with your test database URL"
echo "2. Run: ./scripts/setup-test-db.sh"
echo "3. Run tests: cd backend && npm test"
echo ""
echo "ðŸŒ GitHub Actions:"
echo "   Add TEST_DATABASE_URL secret to your GitHub repository"
echo "   The CI workflow will automatically use it for testing" 